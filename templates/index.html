<!DOCTYPE html>
<html>
<head>
  <title>PSX ‚Äì Port Scanner eXtreme</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #loading-screen {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: white;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #loading-screen img {
      width: 150px;
      animation: spin 1.2s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #log-box {
      background: #f8f9fa;
      padding: 10px;
      height: 300px;
      overflow: auto;
    }
  </style>
</head>
<body class="p-4">

  <!-- Loading Screen -->
  <div id="loading-screen" style="display:none;">
    <img src="https://media.tenor.com/hv7WIBqtTQIAAAAC/naruto-rasengan.gif" alt="Loading...">
    <h4 class="mt-3">Scanning... Rasengan in progress!</h4>
  </div>

  <!-- Permission Modal -->
  <div class="modal fade" id="permissionModal" tabindex="-1" aria-labelledby="permissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-dark">
        <div class="modal-header">
          <h5 class="modal-title" id="permissionModalLabel">Permission Required</h5>
        </div>
        <div class="modal-body">
          ‚ö†Ô∏è You must have explicit permission to scan this domain. Do you confirm that you are authorized to proceed?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="denyBtn">No</button>
          <button type="button" class="btn btn-primary" id="confirmBtn">Yes, I have permission</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <h1 class="mb-4">üîç PSX ‚Äì Port Scanner eXtreme</h1>

    <form id="scan-form">
      <div class="mb-3">
        <input type="text" id="domain" placeholder="Enter domain (e.g. scanme.nmap.org)" class="form-control" required>
      </div>
      <div class="mb-3 d-flex gap-2">
        <input type="number" id="start_port" placeholder="Start Port" class="form-control" required>
        <input type="number" id="end_port" placeholder="End Port" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary">Start Scan</button>
    </form>

    <h4 class="mt-4">üìã Live Log</h4>
    <pre id="log-box"></pre>

    <h4 class="mt-3">‚ö†Ô∏è Threat Level: <span id="threat-level" class="badge bg-secondary">Unknown</span></h4>

    <canvas id="threatChart" width="400" height="200"></canvas>
  </div>

  <script>
    const socket = io();
    const logBox = document.getElementById("log-box");
    const threatBadge = document.getElementById("threat-level");
    const loadingScreen = document.getElementById("loading-screen");

    const ctx = document.getElementById('threatChart').getContext('2d');
    const chartData = {
      labels: ['Low', 'Medium', 'High'],
      datasets: [{
        label: 'Threat Distribution',
        data: [1, 0, 0],
        backgroundColor: ['#198754', '#ffc107', '#dc3545']
      }]
    };
    const threatChart = new Chart(ctx, {
      type: 'bar',
      data: chartData,
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 10
          }
        }
      }
    });

    let pendingScan = null;

    document.getElementById("scan-form").addEventListener("submit", function(e) {
      e.preventDefault();
      pendingScan = {
        domain: document.getElementById("domain").value,
        start_port: document.getElementById("start_port").value,
        end_port: document.getElementById("end_port").value
      };
      new bootstrap.Modal(document.getElementById('permissionModal')).show();
    });

    document.getElementById("confirmBtn").addEventListener("click", () => {
      bootstrap.Modal.getInstance(document.getElementById('permissionModal')).hide();
      if (!pendingScan) return;

      logBox.textContent = "";
      threatBadge.textContent = "Scanning...";
      threatBadge.className = "badge bg-secondary";
      loadingScreen.style.display = "flex";

      socket.emit("start_scan", pendingScan);
    });

    document.getElementById("denyBtn").addEventListener("click", () => {
      alert("Scanning is not allowed without permission. Closing the page.");
      window.close(); // Will only work in some contexts (like new tabs)
      window.location.href = "https://google.com"; // Fallback if close fails
    });

    socket.on("log", function(msg) {
      logBox.textContent += msg + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    });

    socket.on("done", function(data) {
      loadingScreen.style.display = "none";
      const level = data.threat_level;
      let color = "secondary";
      let chartVals = [0, 0, 0];

      if (level === "Low") {
        color = "success";
        chartVals[0] = 1;
      } else if (level === "Medium") {
        color = "warning";
        chartVals[1] = 1;
      } else if (level === "High") {
        color = "danger";
        chartVals[2] = 1;
      }

      threatBadge.textContent = level;
      threatBadge.className = `badge bg-${color}`;
      threatChart.data.datasets[0].data = chartVals;
      threatChart.update();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
